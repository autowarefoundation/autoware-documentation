name: delete-removed-branch-docs

on:
  workflow_call:
    secrets:
      token:
        description: GitHub token
        required: true
  workflow_dispatch:
  pull_request:

jobs:
  delete-removed-branch-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: 3.12

      - name: Install requirements
        run: |
          pip3 install -r mkdocs-requirements.txt
        shell: bash

      - name: List mike versions
        run: |
          mike list
        shell: bash

      - name: List mike versions starting with branch-
        id: branch_versions
        run: |
          BRANCH_VERSIONS="$(mike list | grep '^branch-' || true)"

          if [ -n "$BRANCH_VERSIONS" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

          echo "versions<<EOF" >> $GITHUB_OUTPUT
          echo "$BRANCH_VERSIONS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        shell: bash

      - name: Exit early if no branch-* versions found
        if: ${{ steps.branch_versions.outputs.found == 'false' }}
        run: echo "No branch-* versions found. Exiting successfully."

      - name: Extract stripped branch names
        if: ${{ steps.branch_versions.outputs.found == 'true' }}
        id: stripped
        run: |
          echo "Original versions:"
          echo "${{ steps.branch_versions.outputs.versions }}"

          STRIPPED=$(echo "${{ steps.branch_versions.outputs.versions }}" | sed 's/^branch-//')

          echo "Stripped names:"
          echo "$STRIPPED"

          echo "names<<EOF" >> $GITHUB_OUTPUT
          echo "$STRIPPED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        shell: bash

      - name: List existing git branches (remote)
        id: git_branches
        run: |
          # Fetch ALL remote branches
          git fetch --all --prune --quiet

          # list remote branch names without origin/
          BRANCHES=$(git branch -r --format='%(refname:short)' \
            | sed 's|origin/||' \
            | sort -u)

          echo "All branches in repo:"
          echo "$BRANCHES"

          # Store as GitHub multiline output
          echo "names<<EOF" >> $GITHUB_OUTPUT
          echo "$BRANCHES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        shell: bash

      - name: Delete orphaned mike branch versions
        if: ${{ steps.branch_versions.outputs.found == 'true' }}
        run: |
          echo "==> Mike branch versions:"
          echo "${{ steps.branch_versions.outputs.versions }}"

          echo "==> Stripped mike branch names:"
          MIKE_BRANCHES=$(echo "${{ steps.stripped.outputs.names }}" | sed 's|/|-|g')
          echo "$MIKE_BRANCHES"

          echo "==> Git branches:"
          echo "${{ steps.git_branches.outputs.names }}"

          echo "==> Git branches (slashes -> dashes):"
          GIT_BRANCHES=$(echo "${{ steps.git_branches.outputs.names }}" | sed 's|/|-|g')
          echo "$GIT_BRANCHES"

          # Loop over all mike branches and delete ones not in Git
          echo "$MIKE_BRANCHES" | while read MB; do
            # Skip empty lines
            [ -z "$MB" ] && continue

            if echo "$GIT_BRANCHES" | grep -qx "$MB"; then
              echo "âœ” Keeping: branch-$MB (branch exists)"
            else
              echo "ðŸ”¥ Deleting orphaned mike version: branch-$MB"
              mike delete "branch-$MB"
            fi
          done
        shell: bash
