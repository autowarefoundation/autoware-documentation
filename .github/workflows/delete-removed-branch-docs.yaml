name: delete-removed-branch-docs

on:
  workflow_call:
    secrets:
      token:
        description: GitHub token
        required: true
  workflow_dispatch:
  pull_request:

jobs:
  delete-removed-branch-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: 3.12

      - name: Install requirements
        run: |
          pip3 install -r mkdocs-requirements.txt
        shell: bash

      - name: List mike versions
        run: |
          mike list
        shell: bash

      - name: List mike versions starting with branch-
        id: branch_versions
        run: |
          BRANCH_VERSIONS="$(mike list | grep '^branch-' || true)"

          if [ -n "$BRANCH_VERSIONS" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

          echo "versions<<EOF" >> $GITHUB_OUTPUT
          echo "$BRANCH_VERSIONS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        shell: bash

      - name: Exit early if no branch-* versions found
        if: ${{ steps.branch_versions.outputs.found == 'false' }}
        run: echo "No branch-* versions found. Exiting successfully."

      - name: Extract stripped branch names
        if: ${{ steps.branch_versions.outputs.found == 'true' }}
        id: stripped
        run: |
          echo "Original versions:"
          echo "${{ steps.branch_versions.outputs.versions }}"

          STRIPPED=$(echo "${{ steps.branch_versions.outputs.versions }}" | sed 's/^branch-//')

          echo "Stripped names:"
          echo "$STRIPPED"

          echo "names<<EOF" >> $GITHUB_OUTPUT
          echo "$STRIPPED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        shell: bash

      - name: List existing git branches
        id: git_branches
        run: |
          # Fetch all branches
          git fetch --all --quiet

          # List all branch names
          BRANCHES=$(git for-each-ref --format='%(refname:short)' refs/heads/)

          echo "Branches in repo:"
          echo "$BRANCHES"

          # Store as multiline GitHub Action output
          echo "names<<EOF" >> $GITHUB_OUTPUT
          echo "$BRANCHES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        shell: bash
